# SPDX-License-Identifier: Apache-2.0
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

[tox]
requires =
    tox>=4
env_list = format, flake8, type, py

[testenv]
description = run tests with coverage report
usedevelop=True
deps =
    pytest
    pytest-mock
    pytest-sugar
    coverage>=6
commands =
    coverage run -m pytest {posargs}
    # TODO: ensure 100% coverage of tests
    # coverage report -m --fail-under 100
    coverage report -m

[testenv:test]
description = run tests without coverage report (but in parallel)
usedevelop=True
deps =
    pytest
    pytest-mock
    pytest-sugar
    pytest-xdist
commands =
    pytest -n 4 {posargs}

[testenv:format]
description = run code formatter
skip_install = true
deps =
    isort
    black
commands =
    isort {posargs:src tests}
    black {posargs:src tests}

[testenv:flake8]
description = run flake8
usedevelop=True
skip_install = true
deps =
    flake8
    flake8-bugbear
    flake8-builtins
    flake8-walrus
    flake8-type-checking
    flake8-docstrings>=1.3.1
    pep8-naming
commands =
    flake8 {posargs:src tests}

[testenv:pylint]
description = run pyling
usedevelop=True
deps =
    pylint
commands =
    pylint {posargs:src}

[testenv:type]
setenv =
    MYPYPATH = {toxinidir}/typings
description = run type checks
deps =
    mypy
commands =
    mypy --strict --pretty {posargs:src}

[pytest]
norecursedirs = .git .* *.egg* docs dist build
addopts = -rw --ignore=external --ignore=tests/resources
filterwarnings = error

[coverage:run]
omit =
    external/*

[flake8]
per-file-ignores =
    tests/*: D
max-complexity = 10
ignore =
    E203 W503

[pylint]
disable =
    W1203
